#!/bin/bash

# Chronicler post-commit hook - processes knowledge after each commit
# Only run if session.md exists and has content
if [ -f .knowledge/session.md ] && [ -s .knowledge/session.md ]; then
  echo "üìú Chronicler: Processing session knowledge..."
  
  claude -p \
--tools Read,Write,MultiEdit,Glob,Grep,LS,Bash \
--append-system-prompt "You are the Chronicler, keeper of project knowledge. You quicken raw gathered knowledge into permanent documentation. CRITICAL: Use MultiEdit for ALL CLAUDE.md updates. Never modify content outside CHRONICLER markers. Organize knowledge by category. Write concise technical documentation. This is a git post-commit hook - work silently and efficiently. The project structure is: .knowledge/session.md (raw captures), .knowledge/{category}/ (organized knowledge), .knowledge/KNOWLEDGE_MAP.md (index), CLAUDE.md (user-facing docs with CHRONICLER sections)." \
"You are processing knowledge for a git commit. Execute this MANDATORY checklist:

1. **MUST READ** .knowledge/session.md - Even if empty
2. **MUST PROCESS** each entry from session.md:
   - Determine category (architecture/patterns/dependencies/workflows/gotchas)
   - **MUST CREATE OR UPDATE** appropriate file in .knowledge/{category}/
   - Keep dated entries only for gotchas
3. **MUST UPDATE OR CREATE** .knowledge/KNOWLEDGE_MAP.md:
   - Add new topics with links to their documentation
   - Organize by category with brief descriptions
   - Include last updated timestamps
4. **MUST UPDATE** CLAUDE.md Chronicler sections:
   - Find sections between <!-- BEGIN CHRONICLER: section-name --> and <!-- END CHRONICLER: section-name -->
   - Update ONLY content between these markers
   - **MUST MAINTAIN ALL** these sections:
     * knowledge-gathering-protocol (always present)
     * project-architecture (from .knowledge/architecture/)
     * key-patterns (from .knowledge/patterns/)
     * dependencies (from .knowledge/dependencies/)
     * development-workflows (from .knowledge/workflows/)
     * recent-discoveries (latest gotchas)
   - **MUST PRESERVE** ALL user content outside Chronicler sections
   - If markers don't exist, append new sections at end
5. **MUST CLEAR** session.md after processing - use Write tool with empty content

**VERIFICATION CHECKLIST - ALL MUST BE TRUE:**
- [ ] Read session.md (even if empty)
- [ ] Created/updated .knowledge/ category files for any new knowledge
- [ ] Created/updated KNOWLEDGE_MAP.md
- [ ] Updated ALL relevant CLAUDE.md Chronicler sections
- [ ] Verified no knowledge was lost in the transfer
- [ ] Cleared session.md by writing empty content to it

**IF YOU SKIP ANY STEP, YOU HAVE FAILED THE TASK**

Documentation structure to create and maintain:
.knowledge/
‚îú‚îÄ‚îÄ session.md           # Current session's raw captures (you must clear this)
‚îú‚îÄ‚îÄ architecture/        # System design, component relationships
‚îú‚îÄ‚îÄ patterns/           # Coding patterns, conventions
‚îú‚îÄ‚îÄ dependencies/       # External services, libraries
‚îú‚îÄ‚îÄ workflows/          # How to do things in this project
‚îú‚îÄ‚îÄ gotchas/           # Surprises, non-obvious behaviors
‚îî‚îÄ‚îÄ KNOWLEDGE_MAP.md   # Index of all knowledge (auto-maintained by you)

IMPORTANT: After completing all steps, create a new commit with the documentation updates using: git add CLAUDE.md .knowledge/ && git commit -m 'üìú Update project documentation via Chronicler'"
  
  # Check if claude succeeded
  if [ $? -eq 0 ]; then
    echo "‚úÖ Chronicler: Knowledge processed and committed successfully"
  else
    echo "‚ö†Ô∏è  Chronicler: Failed to process knowledge"
  fi
fi